---
title: CSRF
---

## CSRF Введение

CSRF, подделка межсайтовых запросов на полное имя, подделка межсайтовых запросов. Его легко спутать с XSS. Для CSRF
двумя ключевыми моментами являются межсайтовый запрос и подделка запроса. Поскольку целевая станция не имеет защиты
маркера или отсылающего, злоумышленник может знать каждый параметр чувствительной операции пользователя. Злоумышленник
может подделать полностью идентичный запрос для достижения злонамеренных целей как пользователь.

## Тип CSRF

По типу запроса его можно разделить на тип GET и тип POST.

По способу атаки ее можно разделить на HTML CSRF, JSON HiJacking, Flash CSRF и так далее.

### HTML CSRF

Запрос CSRF выдается с элементами HTML, что является наиболее распространенной атакой CSRF.

Теги в HTML, которые могут быть настроены на адрес ссылки, например `src/href`, могут инициировать запрос GET, например:

```html
<link href="">
<img src="">
<img lowsrc="">
<img dynsrc="">
<meta http-equiv="refresh" content="0; url=">
<iframe src="">
    <frame src="">
    <script src=""></script>
    <bgsound src=""></bgsound>
    <embed src="">
    </bgsound>
    <video src=""></video>
    <audio src=""></audio>
    <a href=""></a>
    <table background=""></table>
    ......
```

Также в стиле CSS:

```css
@import ""
background:url("")
......
```

Формы также могут использоваться для подделки запросов типа POST.

```html
<form action="http://www.a.com/register" id="register" method="post">
    <input type=text name="username" value=""/>
    <input type=password name="password" value=""/>
</form>
<script>
    let f = document.getElementById("register");
    f.inputs[0].value = "test";
    f.inputs[1].value = "passwd";
    f.submit();
</script>
```

### Flash CSRF

Flash также имеет множество способов инициировать сетевые запросы, включая POST.

```js
import flash.net.URLRequest;
import flash.system.Security;
var url = new URLRequest("http://target/page");
var param = new URLVariables();
param = "test=123";
url.method = "POST";
url.data = param;
sendToURL(url);
stop();
```

Flash также может использовать методы `getURL`, `loadVars` и тд., чтобы инициировать запрос.

```js
req = new LoadVars();
req.addRequestHeader("foo", "bar");
req.send("http://target/page?v1=123&v2=222", "_blank", "GET");
```

## Защита CSRF

### Код подтверждения

Код подтверждения заставляет пользователя взаимодействовать с приложением для выполнения последнего запроса.

### Проверка Referer

Убедитесь, что запрос поступил из законного источника. Но сервер не всегда получает Referer.

### Токен

Основная причина, по которой CSRF может успешно атаковать, заключается в том, что злоумышленник может угадать все
параметры важных операций.

Сохраните исходные параметры без изменений, добавьте параметр Token, значение является случайным, в реальном приложении
токен может быть помещен в сеанс пользователя или в файлы cookie браузера.

Жетон должен быть достаточно случайным. Кроме того, цель токена не в том, чтобы предотвратить дублирование отправки,
поэтому для удобства использования разрешено использовать один и тот же токен в течение жизни пользователя до того, как
токен будет использован, но если пользователь уже отправил форму, токен израсходован, токен должен быть восстановлен.

Токен также следует обратить внимание на его конфиденциальность. Если токен появляется в URL-адресе, он может быть
пропущен через Referer. Попытайтесь поместить токен в форму, измените чувствительную операцию с GET на POST, отправьте
ее как форму или AJAX, избегайте токена. 